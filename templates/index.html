{% extends "base.html" %}

{% block content %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<div class="flex flex-col items-center justify-center py-10">
    <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">Rastreador de Fallas</h1>
    <p class="text-gray-500 mb-8">Escanea el QR de la máquina o ingresa el código</p>
    
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md border border-gray-100">
        
        <!-- SECCIÓN DE CÁMARA -->
        <div id="qr-reader-container" class="hidden mb-6">
            <div id="reader" class="w-full rounded-lg overflow-hidden border-2 border-blue-500"></div>
            <button onclick="detenerCamara()" class="mt-3 text-red-600 text-sm hover:underline w-full text-center font-medium">
                <i class="fa-solid fa-times"></i> Cancelar Cámara
            </button>
        </div>

        <button id="btn-scan" onclick="iniciarEscaner()" class="w-full bg-slate-800 text-white font-bold py-4 rounded-lg hover:bg-slate-900 transition mb-6 flex items-center justify-center gap-2 shadow-lg shadow-slate-300/50">
            <i class="fa-solid fa-camera text-xl"></i> Escanear QR
        </button>

        <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-gray-200"></div>
            <span class="flex-shrink mx-4 text-gray-400 text-sm">o manual</span>
            <div class="flex-grow border-t border-gray-200"></div>
        </div>

        <!-- FORMULARIO MANUAL -->
        <form action="/buscar" method="POST" class="space-y-4 mt-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Código (4 dígitos)</label>
                <input 
                    type="text" 
                    name="codigo" 
                    maxlength="4" 
                    placeholder="Ej: 1001" 
                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-2xl tracking-widest font-mono"
                    required
                >
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">
                <i class="fa-solid fa-search"></i> Buscar Historial
            </button>
        </form>
    </div>
</div>

<script>
    let html5QrcodeScanner;

    function iniciarEscaner() {
        document.getElementById('qr-reader-container').classList.remove('hidden');
        document.getElementById('btn-scan').classList.add('hidden');

        html5QrcodeScanner = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            alert("Error al iniciar cámara. Verifica permisos o HTTPS.");
            detenerCamara();
        });
    }

    function detenerCamara() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                resetUI();
            }).catch(err => resetUI());
        } else {
             resetUI();
        }
    }
    
    function resetUI() {
        document.getElementById('qr-reader-container').classList.add('hidden');
        document.getElementById('btn-scan').classList.remove('hidden');
    }

    function onScanSuccess(decodedText, decodedResult) {
        // Detener la cámara una vez leído
        html5QrcodeScanner.stop().then(() => {
            html5QrcodeScanner.clear();
            document.getElementById('qr-reader-container').classList.add('hidden');
            document.getElementById('btn-scan').classList.remove('hidden');
            
            console.log(`Texto escaneado: ${decodedText}`);

            // LOGICA INTELIGENTE:
            let codigoMaquina = decodedText;

            // 1. Si el QR es una URL larga (ej: http://127.0.0.1:5000/maquina/1001)
            // Vamos a "limpiarlo" para quedarnos solo con el "1001"
            if (decodedText.includes('/maquina/')) {
                // Dividimos el texto en dos partes usando "/maquina/" como separador
                const partes = decodedText.split('/maquina/');
                // Nos quedamos con la parte final (el código)
                if (partes.length > 1) {
                    codigoMaquina = partes[1];
                }
            }

            // 2. Redirección RELATIVA
            // Al usar solo "/maquina/" + codigo, el navegador usará automáticamente
            // el dominio en el que estás navegando actualmente (sea localhost, ngrok o vscode)
            window.location.href = "/maquina/" + codigoMaquina;
            
        }).catch(err => {
            console.error("Error al detener el scanner", err);
        });
    }
</script>
{% endblock %}